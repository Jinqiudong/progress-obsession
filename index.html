<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Progress Obsession | è¿›åº¦æ¡å¼ºè¿«ç—‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');

        :root {
            --primary: #6366f1;
            --bg-soft: #fbfcfe;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-soft);
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
        }

        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }

        .tab-active { color: var(--primary); font-weight: 800; position: relative; }
        .tab-active::after { content: ''; position: absolute; bottom: -4px; left: 20%; width: 60%; height: 3px; background: var(--primary); border-radius: 10px; }

        .btn-check-active {
            background: var(--primary);
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
        }

        .btn-press:active { transform: scale(0.92); }

        .day-box { width: 12px; height: 12px; border-radius: 3px; background: #e2e8f0; transition: all 0.3s; }
        .day-box.completed { background: var(--primary); box-shadow: 0 0 8px var(--primary); }

        .task-done { text-decoration: line-through; opacity: 0.3; }
        #progress-bar { transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }

        /* Sortable styles */
        .sortable-ghost { opacity: 0.4; background: #f1f5f9 !important; border-radius: 8px; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen pb-28">
    <div id="app" class="max-w-lg mx-auto px-5 pt-8">
        <!-- Header -->
        <header class="flex justify-between items-start mb-8">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight italic">Progress Obsession<span class="text-indigo-600">.</span></h1>
                <div class="flex items-center gap-3 mt-1">
                    <p id="today-date" class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em]"></p>
                    <button id="lang-toggle" class="text-[9px] font-black text-indigo-400 border border-indigo-100 px-1.5 py-0.5 rounded-md hover:bg-indigo-50 transition-colors uppercase">EN/CN</button>
                </div>
            </div>
            <div class="flex gap-3">
                <button id="btn-settings" class="glass text-slate-500 p-3 rounded-2xl btn-press shadow-sm">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </button>
                <button id="main-add-btn" class="bg-indigo-600 text-white p-3 rounded-2xl shadow-xl shadow-indigo-200 btn-press">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/></svg>
                </button>
            </div>
        </header>

        <!-- Stats Board -->
        <div class="glass rounded-[2.5rem] p-6 mb-8 shadow-sm border border-white/60">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <p id="label-streak" class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">è¿èƒœçºªå½•</p>
                    <div class="flex items-baseline gap-1">
                        <span id="stat-streak" class="text-4xl font-black text-slate-800">0</span>
                        <span id="unit-days" class="text-slate-400 text-xs font-bold uppercase">Days</span>
                    </div>
                </div>
                <div class="text-right">
                    <p id="label-heatmap" class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-2">ç§©åºçƒ­åŠ›å›¾</p>
                    <div id="week-view" class="flex gap-1.5 justify-end"></div>
                </div>
            </div>
            <div class="bg-indigo-50/50 rounded-2xl p-4 flex justify-between items-center">
                <div class="flex flex-col">
                    <span id="label-today-progress" class="text-indigo-600 text-[10px] font-black uppercase tracking-tighter">Today's Progress</span>
                    <span class="text-slate-800 text-xs font-bold"><span id="stat-total">0</span> / <span id="stat-goal">0</span> <span id="unit-achieved">é¡¹è¾¾æˆ</span></span>
                </div>
                <div class="h-2 w-32 bg-indigo-100 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-indigo-600" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Categories -->
        <div class="flex items-center gap-2 mb-6 border-b border-slate-100">
            <nav id="category-tabs" class="flex gap-6 overflow-x-auto pb-3 flex-1 no-scrollbar"></nav>
            <button id="add-cat-trigger" class="pb-3 px-2 text-slate-300 hover:text-indigo-600 font-bold text-xl btn-press">+</button>
        </div>

        <!-- Habits List -->
        <div id="habits-container" class="space-y-5"></div>
    </div>

    <!-- Modal System -->
    <div id="ui-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-md z-50 hidden items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl transition-all scale-95 opacity-0" id="modal-content">
            <h3 id="modal-title" class="text-xl font-extrabold mb-6 text-slate-800 tracking-tight"></h3>

            <div id="modal-body" class="space-y-4">
                <!-- Standard Input -->
                <input type="text" id="modal-input" class="w-full px-5 py-4 rounded-2xl bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500 text-slate-700 font-medium placeholder:text-slate-300" placeholder="åœ¨æ­¤è¾“å…¥...">

                <!-- Habit Specific Extras (Used for Add & Edit) -->
                <div id="modal-habit-extras" class="hidden space-y-4">
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="text-[9px] font-bold text-slate-400 uppercase ml-2 mb-1 block">åˆ†ç±» Category</label>
                            <select id="modal-select" class="w-full px-4 py-3 rounded-xl bg-slate-50 outline-none text-slate-700 font-medium"></select>
                        </div>
                        <div class="flex-1">
                            <label class="text-[9px] font-bold text-slate-400 uppercase ml-2 mb-1 block">é¢‘ç‡ Frequency</label>
                            <select id="modal-freq" class="w-full px-4 py-3 rounded-xl bg-slate-50 outline-none text-slate-700 font-medium">
                                <option value="daily">æ¯æ—¥</option>
                                <option value="workday">å·¥ä½œæ—¥</option>
                                <option value="weekend">å‘¨æœ«</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Settings Specific Extras -->
                <div id="settings-extras" class="hidden space-y-6 pt-2">
                    <div>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">éŸ³æ•ˆé£æ ¼ (Sound Style)</p>
                        <div class="grid grid-cols-2 gap-2" id="sound-options">
                            <button data-sound="crystal" class="sound-btn p-3 rounded-xl border-2 border-slate-100 text-xs font-bold text-slate-500 hover:border-indigo-200 transition-all">ğŸ’ æ°´æ™¶</button>
                            <button data-sound="wooden" class="sound-btn p-3 rounded-xl border-2 border-slate-100 text-xs font-bold text-slate-500 hover:border-indigo-200 transition-all">ğŸªµ æœ¨è´¨</button>
                            <button data-sound="bubble" class="sound-btn p-3 rounded-xl border-2 border-slate-100 text-xs font-bold text-slate-500 hover:border-indigo-200 transition-all">ğŸ«§ æ°”æ³¡</button>
                            <button data-sound="none" class="sound-btn p-3 rounded-xl border-2 border-slate-100 text-xs font-bold text-slate-500 hover:border-indigo-200 transition-all">ğŸ”• é™éŸ³</button>
                        </div>
                    </div>
                    <div>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">æ•°æ®ç®¡ç† (Data Management)</p>
                        <textarea id="modal-textarea" class="w-full h-32 px-5 py-4 rounded-2xl bg-slate-50 outline-none text-[10px] font-mono text-slate-400 no-scrollbar" placeholder="å¤‡ä»½ JSON æ•°æ®..."></textarea>
                    </div>
                </div>
            </div>

            <div id="modal-footer" class="flex gap-4 mt-8">
                <button id="modal-cancel" class="flex-1 py-4 text-slate-400 font-bold text-xs uppercase tracking-widest">Cancel</button>
                <button id="modal-confirm" class="flex-1 bg-indigo-600 text-white rounded-2xl font-bold text-xs shadow-lg shadow-indigo-100 uppercase tracking-widest">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // --- i18n & Config ---
        const i18n = {
            zh: { streak: "è¿èƒœçºªå½•", days: "å¤©", heatmap: "ç§©åºçƒ­åŠ›å›¾", todayProgress: "ä»Šæ—¥è¿›åº¦", achieved: "é¡¹è¾¾æˆ", allSystems: "æ‰€æœ‰ç³»ç»Ÿ", cancel: "å–æ¶ˆ", confirm: "ç¡®å®š" },
            en: { streak: "Streak Count", days: "Days", heatmap: "Order Heatmap", todayProgress: "Today's Progress", achieved: "Goals Done", allSystems: "All Systems", cancel: "Cancel", confirm: "Confirm" }
        };

        // --- Audio System ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let currentSound = localStorage.getItem('app_sound_v2') || 'crystal';

        function playFeedbackSound() {
            if (currentSound === 'none') return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (currentSound === 'crystal') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, now);
                osc.frequency.exponentialRampToValueAtTime(440, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if (currentSound === 'wooden') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.05);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.05);
                osc.start(); osc.stop(now + 0.05);
            } else if (currentSound === 'bubble') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.05);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                osc.start(); osc.stop(now + 0.05);
            }
            if (window.navigator.vibrate) window.navigator.vibrate(10);
        }

        // --- State Management ---
        let currentLang = localStorage.getItem('app_lang') || 'zh';
        let categories = JSON.parse(localStorage.getItem('habits_categories_v9')) || [{ id: '1', name: 'æ—¥å¸¸' }, { id: '2', name: 'ä¸ªäºº' }];
        let habits = JSON.parse(localStorage.getItem('habits_v9')) || [
            { id: 1001, name: "æ™¨é—´æ‹‰ä¼¸", category: "æ—¥å¸¸", freq: "daily", subtasks: ["é¢ˆéƒ¨èˆ’ç¼“"], history: {} }
        ];
        let currentCat = 'å…¨éƒ¨';
        const todayStr = new Date().toISOString().split('T')[0];
        let modalCallback = null;

        // --- Core Functions ---
        function refresh() {
            updateStaticText();
            renderTabs();
            renderHabits();
            updateStats();
            localStorage.setItem('habits_categories_v9', JSON.stringify(categories));
            localStorage.setItem('habits_v9', JSON.stringify(habits));
            localStorage.setItem('app_lang', currentLang);
            localStorage.setItem('app_sound_v2', currentSound);
        }

        function updateStaticText() {
            const t = i18n[currentLang];
            document.getElementById('label-streak').innerText = t.streak;
            document.getElementById('unit-days').innerText = t.days;
            document.getElementById('label-heatmap').innerText = t.heatmap;
            document.getElementById('label-today-progress').innerText = t.todayProgress;
            document.getElementById('unit-achieved').innerText = t.achieved;
            document.getElementById('modal-cancel').innerText = t.cancel;
            document.getElementById('modal-confirm').innerText = t.confirm;
            document.getElementById('today-date').innerText = new Date().toLocaleDateString(currentLang === 'zh' ? 'zh-CN' : 'en-US', { month: 'short', day: 'numeric', weekday: 'short' });
        }

        function isHabitDueToday(habit) {
            const day = new Date().getDay();
            if (habit.freq === 'workday') return day >= 1 && day <= 5;
            if (habit.freq === 'weekend') return day === 0 || day === 6;
            return true;
        }

        function updateStats() {
            const historyDates = new Set();
            let todayDone = 0;
            const dueToday = habits.filter(isHabitDueToday);
            habits.forEach(h => {
                Object.keys(h.history).forEach(d => {
                    if(h.history[d].allDone) historyDates.add(d);
                    if(d === todayStr && h.history[d].allDone) todayDone++;
                });
            });
            let streak = 0;
            let checkDate = new Date();
            while(true) {
                const k = checkDate.toISOString().split('T')[0];
                if(historyDates.has(k)) { streak++; checkDate.setDate(checkDate.getDate() - 1); }
                else { if(k === todayStr && streak === 0) { checkDate.setDate(checkDate.getDate() - 1); continue; } break; }
            }
            document.getElementById('stat-total').innerText = todayDone;
            document.getElementById('stat-goal').innerText = dueToday.length;
            document.getElementById('stat-streak').innerText = streak;
            document.getElementById('progress-bar').style.width = `${dueToday.length ? (todayDone/dueToday.length)*100 : 0}%`;
            const wv = document.getElementById('week-view');
            wv.innerHTML = '';
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const k = d.toISOString().split('T')[0];
                wv.innerHTML += `<div class="day-box ${historyDates.has(k) ? 'completed' : ''}"></div>`;
            }
        }

        function renderTabs() {
            const nav = document.getElementById('category-tabs');
            nav.innerHTML = '';
            const createTab = (id, label) => {
                const b = document.createElement('button');
                b.className = `pb-1 text-[10px] font-black uppercase tracking-widest btn-press transition-all whitespace-nowrap ${currentCat === id ? 'tab-active' : 'text-slate-300'}`;
                b.innerText = label;
                b.onclick = () => { currentCat = id; refresh(); };
                return b;
            };
            nav.appendChild(createTab('å…¨éƒ¨', i18n[currentLang].allSystems));
            categories.forEach(c => nav.appendChild(createTab(c.name, c.name)));
        }

        function renderHabits() {
            const container = document.getElementById('habits-container');
            container.innerHTML = '';
            let filtered = habits.filter(isHabitDueToday);
            if(currentCat !== 'å…¨éƒ¨') filtered = filtered.filter(h => h.category === currentCat);

            filtered.forEach(habit => {
                const dayState = habit.history[todayStr] || { allDone: false, subtasks: [] };
                const card = document.createElement('div');
                card.className = 'glass rounded-[2.5rem] p-6 shadow-sm border border-white/50 relative overflow-hidden group';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1 pr-4">
                            <span class="text-[9px] font-black text-indigo-400 uppercase tracking-widest">${habit.category}</span>
                            <h4 class="font-bold text-slate-800 text-lg leading-tight transition-all ${dayState.allDone ? 'opacity-30 line-through' : ''}">${habit.name}</h4>
                        </div>
                        <div class="flex gap-2">
                            <button class="edit-habit p-3 bg-slate-50 text-slate-300 hover:text-indigo-400 rounded-2xl transition-all btn-press">
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </button>
                            <button class="main-check w-12 h-12 rounded-2xl flex items-center justify-center transition-all btn-press ${dayState.allDone ? 'btn-check-active text-white' : 'bg-slate-50 text-slate-200'}">
                                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-2 subtask-list" data-habit-id="${habit.id}">
                        ${habit.subtasks.map((st, i) => `
                            <div class="flex items-center gap-3 p-1 rounded-lg group/item bg-transparent" data-idx="${i}">
                                <div class="drag-handle text-slate-200 group-hover/item:text-slate-400 transition-colors">
                                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>
                                </div>
                                <input type="checkbox" class="sub-check w-5 h-5 rounded-lg border-2 border-slate-100 text-indigo-600 focus:ring-0 transition-all" data-idx="${i}" ${dayState.subtasks.includes(i) ? 'checked' : ''}>
                                <span class="text-sm font-semibold transition-all flex-1 ${dayState.subtasks.includes(i) ? 'task-done' : 'text-slate-600'}">${st}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-5 pt-4 border-t border-slate-50/50 flex justify-between items-center">
                        <button class="del-habit p-2 text-slate-200 hover:text-red-400 transition-colors">
                            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                        <button class="add-sub text-[9px] font-black text-indigo-400 hover:text-indigo-600 uppercase tracking-widest transition-colors">+ Add Subtask</button>
                    </div>
                `;

                // Subtask Sortable
                const subList = card.querySelector('.subtask-list');
                new Sortable(subList, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        const hId = parseInt(subList.dataset.habitId);
                        const h = habits.find(x => x.id === hId);
                        const item = h.subtasks.splice(evt.oldIndex, 1)[0];
                        h.subtasks.splice(evt.newIndex, 0, item);
                        // History indices need to be reset or cleared when reordering for consistency
                        if(h.history[todayStr]) h.history[todayStr].subtasks = [];
                        refresh();
                    }
                });

                // Events
                card.querySelector('.main-check').onclick = () => {
                    if (!habit.history[todayStr]) habit.history[todayStr] = { allDone: false, subtasks: [] };
                    const d = habit.history[todayStr];
                    if(d.allDone) { delete habit.history[todayStr]; }
                    else { d.allDone = true; d.subtasks = habit.subtasks.map((_, i) => i); playFeedbackSound(); confetti({ particleCount: 150, spread: 70, origin: { y: 0.8 }, colors: ['#6366f1'] }); }
                    refresh();
                };

                card.querySelectorAll('.sub-check').forEach(cb => {
                    cb.onclick = () => {
                        if (!habit.history[todayStr]) habit.history[todayStr] = { allDone: false, subtasks: [] };
                        const d = habit.history[todayStr];
                        const idx = parseInt(cb.dataset.idx);
                        const pos = d.subtasks.indexOf(idx);
                        if(pos > -1) d.subtasks.splice(pos, 1);
                        else { d.subtasks.push(idx); playFeedbackSound(); }
                        const wasAllDone = d.allDone;
                        d.allDone = habit.subtasks.length > 0 && d.subtasks.length === habit.subtasks.length;
                        if(d.allDone && !wasAllDone) { playFeedbackSound(); confetti({ particleCount: 80, spread: 50 }); }
                        refresh();
                    };
                });

                card.querySelector('.add-sub').onclick = () => {
                    openModal('æ‹†è§£å­ä»»åŠ¡', "", (txt) => { if(txt) { habit.subtasks.push(txt); refresh(); } });
                };

                card.querySelector('.edit-habit').onclick = () => {
                    openModal('ç¼–è¾‘å¡ç‰‡', habit.name, (name, cat, freq) => {
                        habit.name = name;
                        habit.category = cat;
                        habit.freq = freq;
                        refresh();
                    }, 'habit', habit.category, habit.freq);
                };

                card.querySelector('.del-habit').onclick = () => {
                    habits = habits.filter(h => h.id !== habit.id);
                    refresh();
                };

                container.appendChild(card);
            });
        }

        // --- UI Modals ---
        function openModal(title, val, cb, type='text', catVal='', freqVal='daily') {
            modalCallback = cb;
            document.getElementById('modal-title').innerText = title;
            document.getElementById('ui-modal').classList.replace('hidden', 'flex');

            const sections = ['modal-input', 'modal-habit-extras', 'settings-extras'];
            sections.forEach(s => document.getElementById(s).classList.add('hidden'));

            if(type === 'habit') {
                document.getElementById('modal-input').classList.remove('hidden');
                document.getElementById('modal-input').value = val;
                document.getElementById('modal-habit-extras').classList.remove('hidden');
                document.getElementById('modal-select').innerHTML = categories.map(c => `<option value="${c.name}" ${c.name === catVal ? 'selected' : ''}>${c.name}</option>`).join('');
                document.getElementById('modal-freq').value = freqVal;
            } else if(type === 'settings') {
                document.getElementById('settings-extras').classList.remove('hidden');
                document.getElementById('modal-input').classList.add('hidden');
                document.getElementById('modal-textarea').value = JSON.stringify({categories, habits}, null, 2);
                updateSoundUI();
            } else {
                document.getElementById('modal-input').classList.remove('hidden');
                document.getElementById('modal-input').value = val;
            }

            setTimeout(() => {
                const content = document.getElementById('modal-content');
                content.classList.replace('scale-95', 'scale-100');
                content.classList.replace('opacity-0', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            const content = document.getElementById('modal-content');
            content.classList.replace('scale-100', 'scale-95');
            content.classList.replace('opacity-100', 'opacity-0');
            setTimeout(() => document.getElementById('ui-modal').classList.replace('flex', 'hidden'), 200);
        }

        function updateSoundUI() {
            document.querySelectorAll('.sound-btn').forEach(btn => {
                if(btn.dataset.sound === currentSound) {
                    btn.classList.add('border-indigo-600', 'text-indigo-600', 'bg-indigo-50');
                } else {
                    btn.classList.remove('border-indigo-600', 'text-indigo-600', 'bg-indigo-50');
                }
            });
        }

        // --- Event Listeners ---
        document.querySelectorAll('.sound-btn').forEach(btn => {
            btn.onclick = () => { currentSound = btn.dataset.sound; updateSoundUI(); playFeedbackSound(); };
        });

        document.getElementById('modal-confirm').onclick = () => {
            const inputVal = document.getElementById('modal-input').value;
            const catVal = document.getElementById('modal-select').value;
            const freqVal = document.getElementById('modal-freq').value;
            const rawData = document.getElementById('modal-textarea').value;

            if(!document.getElementById('settings-extras').classList.contains('hidden')) {
                try {
                    const parsed = JSON.parse(rawData);
                    habits = parsed.habits;
                    categories = parsed.categories;
                } catch(e) {}
                refresh();
            } else if(!document.getElementById('modal-habit-extras').classList.contains('hidden')) {
                modalCallback(inputVal, catVal, freqVal);
            } else {
                modalCallback(inputVal);
            }
            closeModal();
        };

        document.getElementById('modal-cancel').onclick = closeModal;
        document.getElementById('lang-toggle').onclick = () => { currentLang = currentLang === 'zh' ? 'en' : 'zh'; refresh(); };
        document.getElementById('btn-settings').onclick = () => openModal('ç³»ç»Ÿè®¾ç½®', "", null, 'settings');
        document.getElementById('add-cat-trigger').onclick = () => openModal('æ–°åˆ†ç±»', "", (n) => { if(n){categories.push({id:Date.now().toString(),name:n}); refresh();} });
        document.getElementById('main-add-btn').onclick = () => openModal('æ„å»ºæ–°ç§©åº', "", (n,c,f) => {
            if(n) { habits.push({ id: Date.now(), name: n, category: c, freq: f, subtasks: [], history: {} }); refresh(); }
        }, 'habit');

        refresh();
    </script>
</body>
</html>