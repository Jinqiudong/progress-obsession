<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Progress Obsession</title>
    <!-- å¼•å…¥æ ·å¼å’ŒåŠŸèƒ½åº“ï¼šTailwind (CSS), Confetti (çº¸å±‘ç‰¹æ•ˆ), Sortable (æ‹–æ‹½æ’åº) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        /* å­—ä½“ä¸è‡ªå®šä¹‰åŠ¨ç”»æ ·å¼ */
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .page-content { display: none; }
        .page-active { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .tab-active { color: #6366f1; transform: scale(1.1); }
        .task-done { text-decoration: line-through; opacity: 0.4; }
        .mode-badge { font-size: 9px; font-weight: 800; padding: 2px 8px; border-radius: 6px; text-transform: uppercase; }
        /* ä¹ æƒ¯å®Œæˆåº¦å‡†å¤‡å¥½çš„å‘¼å¸æ•ˆæœ */
        .ready-to-check { animation: pulse-purple 2s infinite; border: 2px solid #6366f1 !important; transform: scale(1.05); }
        @keyframes pulse-purple {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
        .emoji-btn.selected { background-color: #6366f1; color: white; transform: scale(1.1); }
    </style>
</head>
<body class="min-h-screen pb-32">

    <!-- å…¨å±åŠ è½½é®ç½©å±‚ -->
    <div id="loading" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="w-8 h-8 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
    </div>

    <div id="app" class="max-w-md mx-auto px-6 pt-10">
        <!-- é¡µé¢ 1ï¼šä¹ æƒ¯æ‰“å¡é¡µ -->
        <section id="page-checkin" class="page-content page-active">
            <header class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-black tracking-tighter italic text-slate-800" id="ui-title">Focus.</h1>
                    <p id="current-date" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1"></p>
                </div>
                <!-- æ·»åŠ æ–°ä¹ æƒ¯æŒ‰é’® -->
                <button id="add-habit-btn" class="bg-indigo-600 text-white w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg active:scale-95 transition-transform">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                </button>
            </header>
            <!-- åˆ†ç±»åˆ‡æ¢æ  -->
            <div class="flex gap-3 mb-6 overflow-x-auto no-scrollbar items-center py-2" id="category-bar"></div>
            <!-- ä¹ æƒ¯åˆ—è¡¨å®¹å™¨ -->
            <div id="habits-container" class="space-y-6"></div>
        </section>

        <!-- é¡µé¢ 2ï¼šåˆ†ææ•°æ® (NEW Content) -->
        <section id="page-insight" class="page-content py-10">
            <h2 class="text-xl font-black mb-8 italic text-left" id="ui-insight-title">Analytics.</h2>

            <!-- æ ¸å¿ƒæ•°æ®æŒ‡æ ‡ -->
            <div class="grid grid-cols-3 gap-3 mb-8" id="stats-grid">
                <!-- ç”± JS å¡«å…… -->
            </div>

            <!-- çƒ­åŠ›è¶‹åŠ¿ -->
            <div class="glass p-6 rounded-[2.5rem] mb-8">
                <div class="flex justify-between items-center mb-6">
                    <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest">7æ—¥è¶‹åŠ¿ / Activity</p>
                    <span id="completion-rate" class="text-[10px] font-black text-indigo-600">--%</span>
                </div>
                <div class="grid grid-cols-7 gap-2" id="activity-heatmap">
                    <!-- ç”± JS å¡«å…… -->
                </div>
            </div>

            <!-- åˆ†ç±»åˆ†æ -->
            <div class="glass p-6 rounded-[2.5rem]">
                <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-6">ä¹ æƒ¯åˆ†å¸ƒ / Distribution</p>
                <div id="category-stats" class="space-y-4">
                    <!-- ç”± JS å¡«å…… -->
                </div>
            </div>
        </section>

        <!-- é¡µé¢ 3ï¼šé…ç½®/è®¾ç½®é¡µ -->
        <section id="page-config" class="page-content py-10">
            <h2 class="text-xl font-black mb-8 italic" id="ui-config-title">Config.</h2>
            <div class="space-y-4">
                <!-- éŸ³æ•ˆè®¾ç½® -->
                <div class="glass p-6 rounded-[2rem] flex items-center justify-between">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wider" id="ui-sound">éŸ³æ•ˆå¼€å…³</span>
                    <button id="btn-sound" class="w-12 h-6 bg-slate-200 rounded-full relative transition-colors">
                        <div id="sound-knob" class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform"></div>
                    </button>
                </div>
                <!-- è¯­è¨€è®¾ç½® -->
                <div class="glass p-6 rounded-[2rem] flex items-center justify-between">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wider" id="ui-lang">è¯­è¨€è®¾ç½®</span>
                    <select id="select-lang" class="bg-transparent text-xs font-black outline-none border-none text-right appearance-none">
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <!-- æ•°æ®å¤‡ä»½æŒ‰é’® -->
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <button onclick="window.exportData()" class="glass p-5 rounded-[1.5rem] text-[10px] font-black uppercase text-slate-400 tracking-widest">å¯¼å‡º JSON</button>
                    <button onclick="window.importData()" class="glass p-5 rounded-[1.5rem] text-[10px] font-black uppercase text-indigo-600 tracking-widest">å¯¼å…¥ JSON</button>
                </div>
                <input type="file" id="import-file" class="hidden" accept=".json">
            </div>
        </section>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[300px] glass rounded-full flex justify-around items-center py-3 px-2 z-50 shadow-xl border-white/50">
        <button data-target="page-checkin" class="tab-btn p-3 text-indigo-600 tab-active">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
        </button>
        <button data-target="page-insight" class="tab-btn p-3 text-slate-300">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
        </button>
        <button data-target="page-config" class="tab-btn p-3 text-slate-300">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        </button>
    </nav>

    <!-- å¼¹çª—æ¨¡æ€æ¡† -->
    <div id="modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl max-h-[90vh] overflow-y-auto relative no-scrollbar">
            <h3 class="text-xl font-black mb-6 italic" id="modal-title">è®¾ç½®.</h3>
            <div id="modal-content" class="space-y-4"></div>
            <div class="flex gap-3 mt-8">
                <button id="modal-cancel" class="flex-1 py-4 font-bold text-slate-300 text-[10px] uppercase tracking-widest text-center">å–æ¶ˆ</button>
                <button id="modal-ok" class="flex-[2] bg-indigo-600 text-white rounded-2xl font-bold text-[10px] uppercase tracking-widest shadow-lg shadow-indigo-100">ç¡®å®š</button>
            </div>
            <!-- éšè—çš„åˆ é™¤ä¹ æƒ¯æŒ‰é’® -->
            <button id="modal-delete-sec" class="hidden absolute top-8 right-8 text-red-400 p-2"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
        </div>
    </div>

    <script type="module">
        // æ ¸å¿ƒå¯¼å…¥ï¼šFirebase èº«ä»½éªŒè¯ä¸æ•°æ®åº“
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase ç¯å¢ƒåˆå§‹åŒ– ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'progress-obs-pro';

        // --- å…¨å±€åº”ç”¨çŠ¶æ€ ---
        let habits = []; // æ‰€æœ‰çš„ä¹ æƒ¯åˆ—è¡¨
        let categories = [{ id: 'daily', name: 'Daily' }, { id: 'work', name: 'Work' }]; // æ‰€æœ‰çš„åˆ†ç±»
        let activeCat = 'ALL'; // å½“å‰é€‰ä¸­çš„åˆ†ç±» ID
        let config = { sound: true, lang: 'zh' }; // åº”ç”¨åŸºç¡€é…ç½®
        let timerInterval = null; // å…¨å±€è®¡æ—¶å™¨æŒ‡é’ˆ
        let currentUser = null; // å½“å‰ç™»å½•çš„ç”¨æˆ·

        // è·å–å½“å‰æ—¥æœŸ Keyï¼ˆä½œä¸ºä¹ æƒ¯å†å²è®°å½•çš„é”®å€¼ï¼‰
        const getTodayKey = () => new Date().toISOString().split('T')[0];
        // å¤‡é€‰å›¾æ ‡åº“
        const EMOJI_LIST = ['ğŸ¾', 'ğŸŠ', 'ğŸ‚', 'â›·ï¸', 'ğŸ¹', 'ğŸ‹ï¸', 'ğŸ¥Š', 'â›¸ï¸', 'â›³ï¸', 'ğŸ¸', 'ğŸª¥', 'ğŸ’‡', 'ğŸ§¹', 'ğŸ§´', 'ğŸ’†', 'ğŸš°', 'ğŸ’Š', 'ğŸˆ', 'ğŸ¥¢', 'ğŸ¨', 'âœï¸', 'ğŸ§¶', 'ğŸ¦·', 'ğŸ§‘â€ğŸ’»', 'ğŸ‘©â€ğŸ’»', 'ğŸ§‘â€ğŸ³', 'ğŸ‘©â€ğŸ³', 'ğŸ’ƒ', 'ğŸ•º', 'ğŸ„', 'ğŸš£', 'ğŸš´', 'ğŸ’¬', 'ğŸ¤¸', 'ğŸ˜Œ', 'ğŸ¤º', 'æ”€', 'æª', 'ğŸƒ', 'ğŸ“š', 'ğŸ§˜', 'ğŸ’§', 'ğŸ', 'ğŸ’ª', 'ğŸ’»', 'ğŸ¹', 'ğŸŒ±', 'ğŸµ', 'ğŸ’¤', 'âœ¨', 'ğŸ”¥', 'ğŸ§ ', 'â˜•ï¸', 'â°'];

        // --- å›½é™…åŒ–æ–‡æœ¬å®šä¹‰ ---
        const I18N = {
            zh: {
                title: 'ä¸“æ³¨.', config: 'é…ç½®.', sound: 'éŸ³æ•ˆå¼€å…³', lang: 'è¯­è¨€è®¾ç½®', add: 'æ–°å»ºä¹ æƒ¯',
                name: 'ä¹ æƒ¯åç§°', type: 'æ¨¡å¼', unit: 'å•ä½', deleteQ: 'ç¡®å®šåˆ é™¤å—ï¼Ÿ',
                cat: 'åˆ†ç±»', emoji: 'å›¾æ ‡', all: 'å…¨éƒ¨',
                cats: { daily: 'æ—¥å¸¸', work: 'å·¥ä½œ' }
            },
            en: {
                title: 'Focus.', config: 'Config.', sound: 'Sound FX', lang: 'Language', add: 'New Habit',
                name: 'Habit Name', type: 'Mode', unit: 'Unit', deleteQ: 'Confirm Delete?',
                cat: 'Category', emoji: 'Icon', all: 'All',
                cats: { daily: 'Daily', work: 'Work' }
            }
        };

        // --- ç”¨æˆ·è®¤è¯ä¸äº‘ç«¯å®æ—¶åŒæ­¥ ---
        const initAuth = async () => {
            // å¦‚æœç¯å¢ƒæä¾›äº† Token åˆ™ç”¨ Token ç™»å½•ï¼Œå¦åˆ™ä½¿ç”¨åŒ¿åç™»å½•
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        // ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                // è®¾ç½®å®æ—¶ç›‘å¬ Firestore ä¸­çš„ç”¨æˆ·æ–‡æ¡£
                onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'main'), (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        // åŒæ­¥äº‘ç«¯æ•°æ®åˆ°å†…å­˜
                        habits = data.habits || [];
                        categories = data.categories || categories;
                        config = { ...config, ...(data.config || {}) };
                    }
                    finishLoading();
                }, (err) => {
                    console.error("Firestore ç›‘å¬é”™è¯¯:", err);
                    finishLoading();
                });
            }
        });

        // æ ¸å¿ƒåŒæ­¥å‡½æ•°ï¼šå°†å†…å­˜ä¸­çš„æ‰€æœ‰æ•°æ®å†™å…¥ Firestore
        async function sync() {
            if (!currentUser) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'main'), {
                    habits, categories, config
                });
            } catch (e) {
                console.error("åŒæ­¥å¤±è´¥:", e);
            }
        }

        // éšè—åŠ è½½é¡µå¹¶æ¸²æŸ“ UI
        function finishLoading() {
            applyConfig();
            render();
            const loader = document.getElementById('loading');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 300);
            }
        }

        // --- UI æ›´æ–°é€»è¾‘ ---

        // æ›´æ–°é¡µé¢é™æ€æ–‡æœ¬ï¼ˆåŸºäºå½“å‰è¯­è¨€é…ç½®ï¼‰
        function applyConfig() {
            const L = I18N[config.lang];
            document.getElementById('ui-title').innerText = L.title;
            document.getElementById('ui-config-title').innerText = L.config;
            document.getElementById('ui-sound').innerText = L.sound;
            document.getElementById('ui-lang').innerText = L.lang;
            document.getElementById('select-lang').value = config.lang;

            const btn = document.getElementById('btn-sound');
            btn.className = `w-12 h-6 rounded-full relative transition-colors ${config.sound ? 'bg-green-500' : 'bg-slate-200'}`;
            document.getElementById('sound-knob').style.transform = config.sound ? 'translateX(24px)' : 'translateX(0px)';
        }

        // è·å–åˆ†ç±»çš„æ˜¾ç¤ºåç§°ï¼ˆå¦‚æœæ˜¯ç³»ç»Ÿé»˜è®¤åˆ†ç±»åˆ™ç¿»è¯‘ï¼‰
        function getCategoryDisplayName(cat) {
            const L = I18N[config.lang];
            if (cat.id === 'daily' || cat.id === 'work') return L.cats[cat.id];
            return cat.name;
        }

        // ä¸»æ¸²æŸ“å‡½æ•°ï¼šåˆ·æ–°é¡µé¢ä¸Šçš„åˆ†ç±»æ¡å’Œä¹ æƒ¯å¡ç‰‡
        function render() {
            const L = I18N[config.lang];
            const dateEl = document.getElementById('current-date');
            if (dateEl) dateEl.innerText = new Date().toLocaleDateString(config.lang === 'zh' ? 'zh-CN' : 'en-US', { weekday: 'long', month: 'short', day: 'numeric' });

            // æ¸²æŸ“åˆ†ç±»ç­›é€‰æ¡
            const catBar = document.getElementById('category-bar');
            catBar.innerHTML = `<button onclick="window.setCat('ALL')" class="px-5 py-2 rounded-full text-[10px] font-black uppercase transition-all flex-shrink-0 ${activeCat==='ALL'?'bg-indigo-600 text-white shadow-md':'bg-white text-slate-300'}">${L.all}</button>` +
                categories.map(c => `<button oncontextmenu="event.preventDefault(); window.editCategory('${c.id}')" onclick="window.setCat('${c.id}')" class="px-5 py-2 rounded-full text-[10px] font-black uppercase transition-all flex-shrink-0 whitespace-nowrap ${activeCat===c.id?'bg-indigo-600 text-white shadow-md':'bg-white text-slate-300'}">${getCategoryDisplayName(c)}</button>`).join('') +
                `<button onclick="window.addCategory()" class="w-9 h-9 rounded-full bg-white text-indigo-400 flex-shrink-0 flex items-center justify-center text-xl font-bold shadow-sm">+</button>`;

            // è¿‡æ»¤å¹¶æ¸²æŸ“ä¹ æƒ¯å¡ç‰‡
            const filtered = activeCat === 'ALL' ? habits : habits.filter(h => h.cat === activeCat);
            document.getElementById('habits-container').innerHTML = filtered.length ? filtered.map(h => renderHabitCard(h)).join('') : `<div class="py-20 text-center opacity-20 font-bold text-sm">è¿˜æ²¡æœ‰ä¹ æƒ¯ï¼Œç‚¹å‡»å³ä¸Šè§’å¼€å§‹ã€‚</div>`;

            // åˆå§‹åŒ–æ’åºåŠŸèƒ½
            initSortable();
        }

        // å•ä¸ªä¹ æƒ¯å¡ç‰‡çš„ HTML ç”Ÿæˆé€»è¾‘
        function renderHabitCard(h) {
            const today = getTodayKey();
            const hist = h.history?.[today] || { done: false, subData: {}, subDone: [] };
            const { totalVal, totalTime } = getHabitStats(h);
            const icon = h.emoji || 'âœ¨';

            // åˆ¤æ–­æ˜¯å¦å‡†å¤‡å¥½æ‰“å¡ï¼šå¦‚æœå­˜åœ¨æ­¥éª¤ï¼Œå¿…é¡»æ‰€æœ‰æ­¥éª¤å®Œæˆ
            const allSubDone = h.steps?.length > 0 && h.steps.every((_, i) => (hist.subDone || []).includes(i));
            const isReady = h.steps?.length > 0 ? (allSubDone && !hist.done) : !hist.done;
            const categoryObj = categories.find(c => c.id === h.cat) || { id: h.cat, name: h.cat };

            return `
                <div class="glass p-6 rounded-[2.5rem] relative shadow-sm border-white overflow-hidden mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex gap-4">
                            <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-2xl shadow-sm border border-slate-50">${icon}</div>
                            <div>
                                <h4 class="font-extrabold text-slate-800 text-lg leading-tight ${hist.done?'task-done':''}">${h.name}</h4>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[9px] font-black text-indigo-400 uppercase tracking-widest">${getCategoryDisplayName(categoryObj)}</span>
                                    <span class="mode-badge ${h.type==='timer'?'bg-orange-50 text-orange-500':h.type==='input'?'bg-blue-50 text-blue-500':'bg-indigo-50 text-indigo-500'}">${h.type}</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="window.editHabitDetails(${h.id})" class="p-2 text-slate-300"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></button>
                    </div>
                    ${h.type !== 'check' ? `<div class="mb-5 bg-slate-50/50 rounded-2xl p-4 flex items-center gap-4"><div class="flex-1"><p class="text-[9px] font-black uppercase text-slate-400 tracking-wider">ä»Šæ—¥è¿›åº¦</p><p class="text-xl font-black text-indigo-600 font-mono">${h.type === 'timer' ? formatTime(totalTime) : totalVal + ' ' + (h.unit||'min')}</p></div></div>` : ''}
                    <!-- å­ä»»åŠ¡/æ­¥éª¤åˆ—è¡¨ -->
                    <div class="space-y-3 mb-6 sub-tasks" data-id="${h.id}">
                        ${(h.steps || []).map((step, idx) => {
                            const subHist = (hist.subData || {})[idx] || { val: 0, timer: 0 };
                            const done = (hist.subDone || []).includes(idx);
                            return `
                            <div class="subtask-row flex items-center gap-3 p-3 bg-white/40 rounded-2xl border border-slate-50">
                                <span class="drag-handle opacity-20 text-[10px] cursor-grab">â‹®â‹®</span>
                                <input type="checkbox" ${done?'checked':''} onchange="window.toggleSubDone(${h.id}, ${idx})" class="w-5 h-5 rounded-md border-2 border-slate-100 appearance-none checked:bg-indigo-600 transition-all">
                                <span class="text-sm font-bold flex-1 truncate ${done?'task-done text-slate-300':''}">${step}</span>
                                <div class="flex items-center gap-2">
                                    <!-- è®¡æ—¶å™¨é€»è¾‘ -->
                                    ${h.type === 'timer' ? `<span class="text-[10px] font-mono font-bold text-orange-600">${formatTime(subHist.timer || 0)}</span><button onclick="window.toggleSubTimer(${h.id}, ${idx})" class="p-1.5 rounded-lg bg-orange-50 text-orange-600"><svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">${subHist.running ? '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>' : '<path d="M8 5v14l11-7z"/>'}</svg></button>` : ''}
                                    <!-- æ•°å€¼è¾“å…¥é€»è¾‘ -->
                                    ${h.type === 'input' ? `<input type="number" value="${subHist.val||''}" onchange="window.updateSubVal(${h.id}, ${idx}, this.value)" placeholder="0" class="w-12 bg-blue-50/50 rounded-lg px-2 py-1 text-[10px] font-bold outline-none text-blue-600 text-right">` : ''}
                                    <button onclick="window.removeStep(${h.id}, ${idx})" class="text-slate-200 ml-1"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="4" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                    <!-- åº•éƒ¨æ“ä½œæ  -->
                    <div class="pt-5 border-t border-slate-50 flex justify-between items-center">
                        <button onclick="window.confirmDeleteHabit(${h.id})" class="p-2 text-slate-200 hover:text-red-400 active:scale-90 transition-transform"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                        <div class="flex items-center gap-4">
                            <button onclick="window.promptSubtask(${h.id})" class="flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-100 text-[9px] font-black uppercase text-slate-500 active:bg-indigo-50">æ·»åŠ æ­¥éª¤</button>
                            <!-- æœ€ç»ˆæ‰“å¡æŒ‰é’® -->
                            <button onclick="window.toggleHabit(${h.id})" class="h-12 w-12 rounded-2xl flex items-center justify-center transition-all ${hist.done?'bg-green-500 text-white shadow-xl shadow-green-100 scale-110': (isReady ? 'ready-to-check bg-indigo-600 text-white shadow-lg' : 'bg-slate-100 text-slate-300')}">
                                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="4" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- å…¨å±€äº¤äº’å‡½æ•° (æŒ‚è½½åˆ° window æ–¹ä¾¿ HTML è°ƒç”¨) ---

        // åˆ‡æ¢å½“å‰åˆ†ç±»
        window.setCat = id => { activeCat = id; render(); };

        // ä¹ æƒ¯æ‰“å¡æ€»å¼€å…³
        window.toggleHabit = id => {
            const h = habits.find(x => x.id === id);
            const today = getTodayKey();
            if(!h.history) h.history = {};
            if(!h.history[today]) h.history[today] = { done: false, subDone: [] };
            const hist = h.history[today];

            // å¦‚æœæœ‰å­ä»»åŠ¡ä½†æ²¡å…¨åšå®Œï¼Œç¦æ­¢ç›´æ¥æ‰“å¡
            const allSubDone = h.steps?.length > 0 && h.steps.every((_, i) => (hist.subDone || []).includes(i));
            if(h.steps?.length > 0 && !allSubDone && !hist.done) return;

            hist.done = !hist.done;
            if(hist.done) {
                // æ’­æ”¾éŸ³æ•ˆå¹¶å–·æ´’çº¸å±‘
                if(config.sound) { try { new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3').play(); } catch(e){} }
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
            }
            sync(); render();
        };

        // åˆ‡æ¢æ­¥éª¤å®ŒæˆçŠ¶æ€
        window.toggleSubDone = (hId, sIdx) => {
            const h = habits.find(x => x.id === hId);
            const today = getTodayKey();
            if(!h.history) h.history = {};
            if(!h.history[today]) h.history[today] = { done: false, subData: {}, subDone: [] };
            const hist = h.history[today];
            if(!hist.subDone) hist.subDone = [];

            if(hist.subDone.includes(sIdx)) hist.subDone = hist.subDone.filter(i => i !== sIdx);
            else hist.subDone.push(sIdx);

            sync(); render();
        };

        // æ­¥éª¤è®¡æ—¶å™¨å¼€å…³
        window.toggleSubTimer = (hId, sIdx) => {
            const h = habits.find(x => x.id === hId);
            const today = getTodayKey();
            if(!h.history) h.history = {};
            if(!h.history[today]) h.history[today] = { subData: {} };
            const hist = h.history[today];
            if(!hist.subData[sIdx]) hist.subData[sIdx] = { timer: 0, val: 0 };
            const sub = hist.subData[sIdx];

            if(sub.running) {
                // åœæ­¢è®¡æ—¶
                sub.running = false;
                clearInterval(timerInterval);
                timerInterval = null;
                sync();
            } else {
                // å¼€å¯è®¡æ—¶å‰å…ˆåœæ­¢æ‰€æœ‰å…¶ä»–æ­£åœ¨è¿è¡Œçš„è®¡æ—¶å™¨
                habits.forEach(ha => {
                    if(ha.history?.[today]?.subData)
                        Object.values(ha.history[today].subData).forEach(s => s.running = false);
                });
                sub.running = true;
                if(timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    sub.timer++;
                    render(); // å®æ—¶åˆ·æ–°æ˜¾ç¤º
                }, 1000);
            }
            render();
        };

        // æ›´æ–°æ­¥éª¤å¯¹åº”çš„æ•°å€¼
        window.updateSubVal = (hId, sIdx, val) => {
            const h = habits.find(x => x.id === hId);
            const today = getTodayKey();
            if(!h.history) h.history = {};
            if(!h.history[today]) h.history[today] = { subData: {} };
            const hist = h.history[today];
            if(!hist.subData[sIdx]) hist.subData[sIdx] = { val: 0 };
            hist.subData[sIdx].val = Number(val);
            sync();
        };

        // æ·»åŠ æ–°ä¹ æƒ¯å¼¹çª—é€»è¾‘
        window.addHabit = () => {
            const L = I18N[config.lang];
            let selectedEmoji = EMOJI_LIST[0];
            const html = `
                <div class="space-y-4">
                    <input id="h-name" placeholder="${L.name}" class="w-full p-5 bg-slate-50 rounded-3xl font-bold outline-none">
                    <div class="p-1">
                        <p class="text-[10px] font-black uppercase text-slate-400 mb-3 tracking-widest">${L.emoji}</p>
                        <div class="grid grid-cols-8 gap-2">
                            ${EMOJI_LIST.slice(0, 16).map(e => `<button onclick="window.selectEmoji(this, '${e}')" class="emoji-btn w-8 h-8 rounded-lg flex items-center justify-center text-lg hover:bg-slate-100 transition-all ${e===selectedEmoji?'selected':''}">${e}</button>`).join('')}
                        </div>
                    </div>
                    <select id="h-cat" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-xs">
                        ${categories.map(c => `<option value="${c.id}" ${activeCat===c.id?'selected':''}>${getCategoryDisplayName(c)}</option>`).join('')}
                    </select>
                    <div class="grid grid-cols-2 gap-3">
                        <select id="h-type" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-xs">
                            <option value="check">å‹¾é€‰</option>
                            <option value="timer">è®¡æ—¶å™¨</option>
                            <option value="input">æ•°å€¼</option>
                        </select>
                        <input id="h-unit" placeholder="${L.unit}" value="min" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-xs outline-none">
                    </div>
                </div>`;

            window.currentEmoji = selectedEmoji;
            window.selectEmoji = (btn, e) => {
                document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                window.currentEmoji = e;
            };

            openModal(L.add, html, () => {
                const name = document.getElementById('h-name').value;
                if(name) {
                    habits.push({
                        id: Date.now(),
                        name,
                        emoji: window.currentEmoji,
                        cat: document.getElementById('h-cat').value,
                        type: document.getElementById('h-type').value,
                        unit: document.getElementById('h-unit').value,
                        steps: [],
                        history: {}
                    });
                    sync(); render();
                }
            });
        };

        // ç¼–è¾‘ç°æœ‰ä¹ æƒ¯
        window.editHabitDetails = (id) => {
            const h = habits.find(x => x.id === id);
            let selectedEmoji = h.emoji || EMOJI_LIST[0];
            const html = `<div class="space-y-4"><input id="h-name" value="${h.name}" class="w-full p-5 bg-slate-50 rounded-3xl font-bold outline-none"><div class="p-1"><div class="grid grid-cols-8 gap-2">${EMOJI_LIST.slice(0, 16).map(e => `<button onclick="window.selectEmoji(this, '${e}')" class="emoji-btn w-8 h-8 rounded-lg flex items-center justify-center text-lg hover:bg-slate-100 transition-all ${e===selectedEmoji?'selected':''}">${e}</button>`).join('')}</div></div><select id="h-cat" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-xs">${categories.map(c => `<option value="${c.id}" ${h.cat===c.id?'selected':''}>${getCategoryDisplayName(c)}</option>`).join('')}</select></div>`;
            window.currentEmoji = selectedEmoji;
            window.selectEmoji = (btn, e) => {
                document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                window.currentEmoji = e;
            };
            openModal("ç¼–è¾‘ä¹ æƒ¯", html, () => {
                h.name = document.getElementById('h-name').value;
                h.emoji = window.currentEmoji;
                h.cat = document.getElementById('h-cat').value;
                sync(); render();
            });
        };

        // åˆ é™¤ç¡®è®¤
        window.confirmDeleteHabit = (id) => {
            openModal("ç¡®è®¤åˆ é™¤ï¼Ÿ", `<p class="text-slate-400 font-bold text-sm">åˆ é™¤åæ•°æ®æ— æ³•æ‰¾å›ã€‚</p>`, () => {
                habits = habits.filter(h => h.id !== id);
                sync(); render();
            });
        };

        // åˆ†ç±»æ“ä½œ
        window.addCategory = () => {
            openModal("æ–°å»ºåˆ†ç±»", `<input id="cat-name" placeholder="åˆ†ç±»åç§°" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">`, () => {
                const name = document.getElementById('cat-name').value;
                if(name) { categories.push({ id: 'cat_' + Date.now(), name }); sync(); render(); }
            });
        };

        window.editCategory = (catId) => {
            if(catId === 'daily' || catId === 'work') return;
            const c = categories.find(x => x.id === catId);
            const delBtn = document.getElementById('modal-delete-sec');
            delBtn.classList.remove('hidden');
            delBtn.onclick = () => {
                categories = categories.filter(x => x.id !== catId);
                habits.forEach(h => { if(h.cat === catId) h.cat = 'daily'; });
                document.getElementById('modal').classList.add('hidden');
                sync(); render();
            };
            openModal("ç¼–è¾‘åˆ†ç±»", `<input id="cat-name" value="${c.name}" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">`, () => {
                c.name = document.getElementById('cat-name').value;
                sync(); render();
            });
        };

        // ä¸ºä¹ æƒ¯æ·»åŠ å…·ä½“æ­¥éª¤
        window.promptSubtask = id => {
            openModal("æ·»åŠ æ­¥éª¤", `<input id="sub-input" autofocus placeholder="æ­¥éª¤æè¿°..." class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">`, () => {
                const val = document.getElementById('sub-input').value;
                if(val) {
                    const h = habits.find(x => x.id === id);
                    if(!h.steps) h.steps = [];
                    h.steps.push(val);
                    sync(); render();
                }
            });
        };

        // ç§»é™¤æŸä¸ªæ­¥éª¤
        window.removeStep = (hId, sIdx) => {
            const h = habits.find(x => x.id === hId);
            h.steps.splice(sIdx, 1);
            sync(); render();
        };

        // æ•°æ®å¯¼å…¥å¯¼å‡ºï¼ˆæœ¬åœ° JSON æ–‡ä»¶ï¼‰
        window.exportData = () => {
            const b = new Blob([JSON.stringify({ habits, config, categories })], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = `focus_data_${getTodayKey()}.json`;
            a.click();
        };

        window.importData = () => document.getElementById('import-file').click();

        document.getElementById('import-file').onchange = (e) => {
            const r = new FileReader();
            r.onload = (re) => {
                try {
                    const d = JSON.parse(re.target.result);
                    habits = d.habits||[];
                    config = d.config||config;
                    categories = d.categories||categories;
                    sync(); render();
                } catch(err) { alert("æ–‡ä»¶æ— æ•ˆ"); }
            };
            r.readAsText(e.target.files[0]);
        };

        // --- å†…éƒ¨è¾…åŠ©å‡½æ•° ---

        // æ‰“å¼€å¼¹çª—æ¨¡æ€æ¡†å¹¶é…ç½®é€»è¾‘
        function openModal(title, html, onOk) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal-delete-sec').classList.add('hidden');
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal-ok').onclick = () => { onOk(); document.getElementById('modal').classList.add('hidden'); };
            document.getElementById('modal-cancel').onclick = () => document.getElementById('modal').classList.add('hidden');
        }

        // è®¡ç®—ä¸€ä¸ªä¹ æƒ¯å½“å¤©çš„ç´¯è®¡æ•°æ®ï¼ˆæ•°å€¼æˆ–æ—¶é•¿ï¼‰
        function getHabitStats(h) {
            const today = getTodayKey();
            const hist = h.history?.[today] || { subData: {} };
            let totalVal = 0, totalTime = 0;
            if (h.steps?.length) {
                h.steps.forEach((_, i) => {
                    const d = (hist.subData || {})[i] || { val: 0, timer: 0 };
                    totalVal += Number(d.val || 0);
                    totalTime += Number(d.timer || 0);
                });
            } else {
                totalVal = Number(hist.val || 0);
                totalTime = Number(hist.timer || 0);
            }
            return { totalVal, totalTime };
        }

        // ç§’æ•°è½¬ MM:SS æ ¼å¼
        function formatTime(s) {
            const m = Math.floor(s/60);
            const sec = s % 60;
            return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        }

        // åˆå§‹åŒ–å­ä»»åŠ¡æ‹–æ‹½æ’åº
        function initSortable() {
            document.querySelectorAll('.sub-tasks').forEach(el => {
                new Sortable(el, {
                    handle: '.drag-handle',
                    animation: 200,
                    onEnd: (e) => {
                        const hId = parseInt(el.dataset.id);
                        const h = habits.find(x => x.id === hId);
                        const [moved] = h.steps.splice(e.oldIndex, 1);
                        h.steps.splice(e.newIndex, 0, moved);
                        sync();
                    }
                });
            });
        }

        // --- é…ç½®é¡µé¢ DOM äº‹ä»¶ç›‘å¬ ---
        document.getElementById('add-habit-btn').onclick = () => window.addHabit();

        document.getElementById('btn-sound').onclick = () => {
            config.sound = !config.sound;
            applyConfig(); sync();
        };

        document.getElementById('select-lang').onchange = (e) => {
            config.lang = e.target.value;
            applyConfig(); render(); sync();
        };

        // åº•éƒ¨å¯¼èˆªæ åˆ‡æ¢é€»è¾‘
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.page-content').forEach(p => p.classList.remove('page-active'));
                document.getElementById(btn.dataset.target).classList.add('page-active');
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('tab-active', 'text-indigo-600');
                    b.classList.add('text-slate-300');
                });
                btn.classList.add('tab-active', 'text-indigo-600');
            };
        });

        // æµç¨‹å¯åŠ¨ï¼šå…ˆè¿›è¡Œèº«ä»½éªŒè¯
        initAuth();
    </script>
</body>
</html>